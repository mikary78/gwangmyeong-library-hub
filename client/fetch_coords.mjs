
const libraries = [
    {
        "번호": 1,
        "도서관명": "하늘꿈 작은도서관",
        "주소": "경기도 광명시 너부대로45번안길 20-19 (광명동) 2층",
        "전화번호": "02-2686-3377",
        "운영유형": "사립"
    },
    {
        "번호": 2,
        "도서관명": "너 꿈 도서관",
        "주소": "경기도 광명시 너부대로35번길 20 (광명동) 광명5동행정복지센터",
        "전화번호": "02-2680-5009",
        "운영유형": "공립"
    },
    {
        "번호": 3,
        "도서관명": "좋은친구들 작은도서관",
        "주소": "경기도 광명시 광화로 6 (광명동) 4층",
        "전화번호": "02-2625-7634",
        "운영유형": "사립"
    },
    {
        "번호": 4,
        "도서관명": "서면 작은도서관",
        "주소": "경기도 광명시 오리로403번길 3 (소하동) 4층",
        "전화번호": "02-897-8937",
        "운영유형": "사립"
    },
    {
        "번호": 5,
        "도서관명": "우리마을 작은도서관",
        "주소": "경기도 광명시 범안로 1061 (하안동) 우리 마을 작은 도서관 7층",
        "전화번호": "000-0000-0000",
        "운영유형": "사립"
    },
    {
        "번호": 6,
        "도서관명": "새움작은도서관",
        "주소": "경기도 광명시 도덕공원로 29 (소하동) 소하2동행정복지센터",
        "전화번호": "02-2680-5703",
        "운영유형": "공립"
    },
    {
        "번호": 7,
        "도서관명": "하안작은도서관",
        "주소": "경기도 광명시 도덕로 27 (하안동) 하안4동우체국 3층",
        "전화번호": "02-897-3357",
        "운영유형": "사립"
    },
    {
        "번호": 8,
        "도서관명": "꿈드림 작은도서관",
        "주소": "경기도 광명시 도덕로 83 (하안동) 흥안주공시범아파트",
        "전화번호": "02-497-4637",
        "운영유형": "사립"
    },
    {
        "번호": 9,
        "도서관명": "기쁨 작은도서관",
        "주소": "경기도 광명시 도덕로 159 (하안동) 광문교회",
        "전화번호": "000-0000-0000",
        "운영유형": "사립"
    },
    {
        "번호": 10,
        "도서관명": "소망의 작은도서관",
        "주소": "경기도 광명시 도덕로 171-3 (하안동) 광명평생교육원",
        "전화번호": "02-011-0000",
        "운영유형": "사립"
    },
    {
        "번호": 11,
        "도서관명": "모두의작은도서관",
        "주소": "경기도 광명시 디지털로 34 (철산동) 2층 1호",
        "전화번호": "02-897-8296",
        "운영유형": "사립"
    },
    {
        "번호": 12,
        "도서관명": "디딤돌 작은도서관",
        "주소": "경기도 광명시 범안로 919 (하안동) 5층 광명광성교회",
        "전화번호": "02-807-8339",
        "운영유형": "사립"
    },
    {
        "번호": 13,
        "도서관명": "하안청소년 작은도서관",
        "주소": "경기도 광명시 범안로 1026 (하안동) 광명청소년수련관",
        "전화번호": "02-2617-9314",
        "운영유형": "공립"
    },
    {
        "번호": 14,
        "도서관명": "새마을작은도서관",
        "주소": "경기도 광명시 범안로 1044 (하안동) 하안1동제1호공영주차장 3층",
        "전화번호": "02-2618-2060",
        "운영유형": "사립"
    },
    {
        "번호": 15,
        "도서관명": "교통안전 작은도서관",
        "주소": "경기도 광명시 소하로 116 (소하동) GUU 능촌 매니저 아파트 113",
        "전화번호": "010-9913-9683",
        "운영유형": "사립"
    },
    {
        "번호": 16,
        "도서관명": "기쁨이있는 작은도서관",
        "주소": "경기도 광명시 소하로 127 (소하동) 하안종합사회복지관",
        "전화번호": "02-898-7223",
        "운영유형": "사립"
    },
    {
        "번호": 17,
        "도서관명": "한내 작은도서관",
        "주소": "경기도 광명시 소하로38번안길 6 (소하동) 평생학습원한내",
        "전화번호": "02-898-7173",
        "운영유형": "공립"
    },
    {
        "번호": 18,
        "도서관명": "해오름 작은도서관",
        "주소": "경기도 광명시 시청로 37 (철산동)",
        "전화번호": "02-2614-5815",
        "운영유형": "사립"
    },
    {
        "번호": 19,
        "도서관명": "중앙 행복한 작은도서관",
        "주소": "경기도 광명시 시청로 46 (철산동) 로데오빌딩 211호",
        "전화번호": "02-2684-6100",
        "운영유형": "사립"
    },
    {
        "번호": 20,
        "도서관명": "하안누리문고",
        "주소": "경기도 광명시 오리로854번길 3 (하안동)",
        "전화번호": "02-897-6200",
        "운영유형": "사립"
    },
    {
        "번호": 21,
        "도서관명": "꿈을 여는 작은도서관",
        "주소": "경기도 광명시 오리로907번길 3 (하안동) 3층(303호)",
        "전화번호": "02-803-2162",
        "운영유형": "사립"
    },
    {
        "번호": 22,
        "도서관명": "깨우는 작은도서관",
        "주소": "경기도 광명시 오리로907번길 4 (하안동) 301호 작은도서관",
        "전화번호": "02-899-1192",
        "운영유형": "사립"
    },
    {
        "번호": 23,
        "도서관명": "너부 영유아 도서관",
        "주소": "경기도 광명시 철산로 38 (철산동) 철산초등학교",
        "전화번호": "02-2680-5819",
        "운영유형": "공립"
    },
    {
        "번호": 24,
        "도서관명": "너부아트빌 도서관",
        "주소": "경기도 광명시 철산로 37 (철산동) 아트빌아파트상가201호",
        "전화번호": "02-897-7973",
        "운영유형": "사립"
    },
    {
        "번호": 25,
        "도서관명": "우리동네 작은도서관",
        "주소": "경기도 광명시 철산로 40 (철산동) 주공13단지 생활복지센터 내",
        "전화번호": "02-2619-0685",
        "운영유형": "사립"
    },
    {
        "번호": 26,
        "도서관명": "조은별유치원 작은도서관",
        "주소": "경기도 광명시 철산로 42 (철산동) 조은별유치원",
        "전화번호": "02-2612-0202",
        "운영유형": "사립"
    },
    {
        "번호": 27,
        "도서관명": "지혜의 집 작은도서관",
        "주소": "경기도 광명시 철산로 56 (철산동) 철산어린이집",
        "전화번호": "02-2683-2789",
        "운영유형": "사립"
    },
    {
        "번호": 28,
        "도서관명": "별빛 작은도서관",
        "주소": "경기도 광명시 철산로 70 (철산동) 철산3동 행정복지센터 내 2층",
        "전화번호": "02-2680-6006",
        "운영유형": "공립"
    },
    {
        "번호": 29,
        "도서관명": "큰나무작은도서관",
        "주소": "경기도 광명시 철산로17번길 4 (철산동) 4층",
        "전화번호": "02-2686-1191",
        "운영유형": "사립"
    },
    {
        "번호": 30,
        "도서관명": "성모 작은도서관",
        "주소": "경기도 광명시 철산로21번길 27-5 (철산동) 성당사무실",
        "전화번호": "02-2682-6400",
        "운영유형": "사립"
    },
    {
        "번호": 31,
        "도서관명": "철산뜰 작은도서관",
        "주소": "경기도 광명시 철산로39번길 16 (철산동) 104동 2층",
        "전화번호": "02-2680-6079",
        "운영유형": "공립"
    },
    {
        "번호": 32,
        "도서관명": "앤의 작은도서관",
        "주소": "경기도 광명시 철산로41번길 21 (철산동) 주공1단지아파트 121동앞 상가",
        "전화번호": "02-2060-6080",
        "운영유형": "사립"
    },
    {
        "번호": 33,
        "도서관명": "푸른이삭학교 작은도서관",
        "주소": "경기도 광명시 하안로 347 (소하동) 효성해링턴 플레이스 상가 지하1층",
        "전화번호": "02-2083-9143",
        "운영유형": "사립"
    },
    {
        "번호": 34,
        "도서관명": "새마을 중앙 작은도서관",
        "주소": "경기도 광명시 한내일로 40 (광명동) 밤일마을 작은도서관",
        "전화번호": "02-2060-5445",
        "운영유형": "사립"
    },
    {
        "번호": 35,
        "도서관명": "이루마 작은도서관",
        "주소": "경기도 광명시 한주로 463 (일직동) 광명6단지아파트 601-601호",
        "전화번호": "02-2250-7817",
        "운영유형": "사립"
    },
    {
        "번호": 36,
        "도서관명": "한결같은 작은도서관",
        "주소": "경기도 광명시 한주로 523 (일직동) 상가동비스타동 205호",
        "전화번호": "02-2230-7433",
        "운영유형": "사립"
    },
    {
        "번호": 37,
        "도서관명": "꿈꾸는 도토리 작은도서관",
        "주소": "경기도 광명시 한주로 606 (일직동) 2층 201호",
        "전화번호": "02-899-2010",
        "운영유형": "사립"
    },
    {
        "번호": 38,
        "도서관명": "책읽는소하 작은도서관",
        "주소": "경기도 광명시 호랭이거리 4 (소하동) 3층",
        "전화번호": "02-894-8600",
        "운영유형": "사립"
    },
    {
        "번호": 39,
        "도서관명": "푸른하늘작은도서관",
        "주소": "경기도 광명시 호봉골길 35 (하안동) 푸른하늘 어린이집 2층",
        "전화번호": "02-898-3653",
        "운영유형": "사립"
    },
    {
        "번호": 40,
        "도서관명": "광명6동 작은도서관",
        "주소": "경기도 광명시 희광로 20 (광명동) 광명6동 행정복지센터 2층",
        "전화번호": "02-2680-5058",
        "운영유형": "공립"
    },
    {
        "번호": 41,
        "도서관명": "꿈틀 꿈틀 작은도서관",
        "주소": "경기도 광명시 신기로 20 (소하동) 소하1동행정복지센터",
        "전화번호": "02-811-1242",
        "운영유형": "공립"
    },
    {
        "번호": 42,
        "도서관명": "포이즌 앤 북스 작은도서관",
        "주소": "경기도 광명시 디지털로 34 31층 1호(철산동)",
        "전화번호": "02-2680-6575",
        "운영유형": "사립"
    }
];

async function fetchCoordinates() {
    const results = [];

    console.log(`Fetching coordinates for ${libraries.length} libraries...`);

    for (const lib of libraries) {
        try {
            const query = lib['주소'];
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;

            console.log(`Processing ${lib['번호']}/${libraries.length}: ${lib['도서관명']}`);

            const response = await fetch(url, {
                headers: {
                    'User-Agent': 'GwangmyeongLibraryHub/1.0 (contact@example.com)'
                },
                signal: AbortSignal.timeout(5000) // 5s timeout
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            let lat = 0;
            let lng = 0;

            if (data && data.length > 0) {
                lat = parseFloat(data[0].lat);
                lng = parseFloat(data[0].lon);
                console.log(`  -> Found: ${lat}, ${lng}`);
            } else {
                console.log(`  -> Not Found`);

                // Retry logic simplified
                const simpleAddress = query.replace(/\([^)]*\)/g, '').split(' ').slice(0, 4).join(' ');
                if (simpleAddress !== query) {
                    console.log(`  -> Retrying with: ${simpleAddress}`);
                    try {
                        const url2 = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(simpleAddress)}`;
                        const response2 = await fetch(url2, {
                            headers: { 'User-Agent': 'GwangmyeongLibraryHub/1.0' },
                            signal: AbortSignal.timeout(5000)
                        });
                        const data2 = await response2.json();
                        if (data2 && data2.length > 0) {
                            lat = parseFloat(data2[0].lat);
                            lng = parseFloat(data2[0].lon);
                            console.log(`  -> Found (retry): ${lat}, ${lng}`);
                        }
                    } catch (e) {
                        console.log(`  -> Retry failed: ${e.message}`);
                    }
                }
            }

            results.push({
                id: lib['번호'],
                name: lib['도서관명'],
                address: lib['주소'],
                phone: lib['전화번호'],
                type: lib['운영유형'],
                lat: lat,
                lng: lng
            });

            // Respect rate limit (1 request per second)
            await new Promise(resolve => setTimeout(resolve, 1100));

        } catch (error) {
            console.error(`Error fetching ${lib['도서관명']}:`, error.message);
            results.push({
                id: lib['번호'],
                name: lib['도서관명'],
                address: lib['주소'],
                phone: lib['전화번호'],
                type: lib['운영유형'],
                lat: 0,
                lng: 0
            });
        }
    }

    console.log('Done.');

    const fs = await import('fs');
    fs.writeFileSync('libraries_with_coords.json', JSON.stringify(results, null, 2), 'utf-8');
    console.log('Saved to libraries_with_coords.json');
}

fetchCoordinates();
